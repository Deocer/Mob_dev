<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
    <link type="text/css" rel="stylesheet" href="https://api.mqcdn.com/sdk/mapquest-js/v1.3.2/mapquest.css" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.15.4/js/all.js" data-auto-a11y="true"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <title></title>
</head>
<style type="text/css">

#map { 
  height: 350px;
  width: 300px;
  } 

 .swal-footer {
  text-align: center;
}
.swal-icon{
    margin: 0;
}

.wcard {
  background: #fff;
  width: 100%;
  display: flex;
  align-items: center;
  border-radius: 10px;
  padding: 10px;
}
.wcard__info__place {
  font-size: 14px;
  color: var(--primary-light);
}
.wcard__info__time {
  font-size: 20px;
  font-weight: bold;
  color: var(--primary);
}
.wcard__info__date {
  font-size: 14px;
  color: var(--primary-light);
}
.wcard__weather {
  margin-left: auto;
  align-items: center;
}

.wcard__weather__icon {
  animation: move 1s infinite alternate ease-in-out;
}

@keyframes move {
  to {
    transform: translateY(-10px);
  }
}


</style>
<body>
<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v12.0" nonce="hdJdVgSL"></script>



<div class="container-fluid text-center">
    <h1 class="text-primary" >FLOOD HELP APP</h1>
  </div>
<div class="container-fluid text-center">
 <ul class="nav nav-tabs" id="myTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true"> <b>Info</b></button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false"> <b>Evacuation Site</b> </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false"> <b>Flood History</b> </button>
  </li>
</ul> 
</div>  




<div class="tab-content" id="myTabContent">


  <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab" style="background-color:whitesmoke;">

<br> 
<div class="wcard">

  <div class="wcard__info"  style="flex-grow: 3">
    <p class="wcard__info__place text-muted" id="weather">Marikina</p>
    <p class="wcard__info__time"  style="font-size:30px">Marikina</p>
    <p class="wcard__info__date text-muted"><i class="fas fa-wind"></i>
     <span id="wind"></span></p>
    <p class="wcard__info__date text-muted" id="date">Novemaber 10.2020 | Wednesday</p>
  </div>

 
  <div class="wcard__weather"  style="flex-grow: 1">
   <img src="" class="card-img wcard__weather__icon" id="weathericon" alt="..." style="width:90px; height: 90px; margin:auto;">
    <div style="margin: 0;">
      <p class=""><span style="font-size:28px; margin: 0;"> <i class="fas fa-temperature-high"></i> </span> <span id="c" style="font-size:25px; margin: 0;"> </span></p> 
      <p class="card-text"> <span id="fs" style="font-size:20px; margin: 0"></span></p>
    </div>
  </div>

</div>
<br>
<div style="text-align: center; margin: auto; background: #fff;  border-radius: 10px; padding: 10px;">
  <p class="text-lead" style="font-size:15px;font-weight: bold;">UPDATES AND BROADCAST</p>
</div>


<div class="bg-light" style="margin:auto; text-align: center;">
  
<iframe src="https://www.facebook.com/plugins/page.php?href=https%3A%2F%2Fwww.facebook.com%2FMarikinaPIO&tabs&width=400&height=70&small_header=true&adapt_container_width=true&hide_cover=false&show_facepile=false&appId" width="400" height="70" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowfullscreen="true" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>


</div>

<div id="socials">

</div>
 <!--- <a class="twitter-timeline" href="https://twitter.com/MarikinaPIO"></a>  --->

<div id="fb" style="margin:auto; text-align:center;">

</div>



  </div>



  <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab" style="background-color:whitesmoke;">

    <br>

          <div class="row g-0">
            <div class="col-md-4">

              <a class="hover">
                <div class="img">
                  <img  src="" id="pimg" class="img-fluid rounded-start" alt="..." style="height:20vh; width:100%;">
                </div>
              </a>
              
            </div>
            <div class="col-md-8">
              <div class="card-body" style="width: 100%; text-align: left; font-weight: 900;">
                <p class="text-muted" id="evt" style="font-weight: 900i;">SELECT AN EVACUATION SITE:</p>
                <h5 class="text-muted" id="loctab"></h5>
                <p class="card-text"><i class="fas fa-map-marker-alt text-muted"></i> <span id="at"></span> <span id="on"></span> .</p>
                <p class="card-text"><small class="text-muted"> <span>Capacity:</span> <span id="cap"></span> </small></p>
                <button type="button" id="directions" class="btn btn-primary" style="font-size:1.5vh;"><b>Show Direction to Evacuation Site</b></button>
              </div>
            </div>
          </div>

      <br>
      <div id="map" style="width: 100%;"></div>
      <br>


  </div>
  <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab" >

    <div style="margin:auto; text-align:center;" style="background-color:whitesmoke;">
      <br>
       <div id="columnchart_values" style="width: 80%; padding-left: 30px;"></div>
    </div>
   
    <div id="typhoon" style="background-color:whitesmoke;">
      
    </div>


  </div>
</div>



</body>
<script async  src="https://platform.twitter.com/widgets.js"  charset="utf-8"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>

<script type="text/javascript">

var lt = sessionStorage.getItem('ulat');
var ln = sessionStorage.getItem('ulot'); 

            var map = L.map('map').setView([lt,ln], 13);

      const schoolIcon = L.divIcon({
          html: '<i class="fas fa-school"></i>',
          iconSize: [30, 30],
          className: 'myDivIcon'
      });

      const hallIcon = L.divIcon({
          html: '<i class="fas fa-warehouse"></i>',
          iconSize: [30, 30],
          className: 'myDivIcon'
      }); 
      const homeIcon = L.divIcon({
          html: '<i class="fas fa-home"></i>  ',
          iconSize: [30, 30],
          className: 'myDivIcon'
      }); 



      L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZGVvY2VyIiwiYSI6ImNreTgza3hqZzFicHYycG80bGU1cHZibm4ifQ.rXESocLMAlZFXlscURdwaQ', {
          attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
          maxZoom: 18,
          id: 'mapbox/streets-v11',
          tileSize: 512,
          zoomOffset: -1,
          accessToken: 'pk.eyJ1IjoiZGVvY2VyIiwiYSI6ImNreTgza3hqZzFicHYycG80bGU1cHZibm4ifQ.rXESocLMAlZFXlscURdwaQ'
      }).addTo(map);

      L.marker([lt,ln], {icon :homeIcon}).addTo(map).bindPopup('Home');



                    $.ajax({
                      url: 'https://evac-marikina-default-rtdb.asia-southeast1.firebasedatabase.app/.json?orderBy="$key"&print=pretty',
                      type: "GET",
                      success: function (res) {
                        // Decoding the response to native JS object
                        var sites = JSON.stringify(res);
                        var jsob = JSON.parse(sites);
                        console.log(jsob);
                        // Looping to the Native JS object to produce markers in the Map


                        const schools =[];
                        const halls = [];
                        const all = [];


                        const lmt = jsob.sites.length;
                        for (let i = 0; i < lmt; i++) {

                          if (jsob.sites[i].type === "school") {

                            var popup = L.popup().setContent("<div id='"+jsob.sites[i].name+"' ontouchstart='fill_card("+jsob.sites[i].lat+","+jsob.sites[i].lot+","+"`"+jsob.sites[i].name+"`"+","+"`"+jsob.sites[i].src+"`"+","+"`"+jsob.sites[i].cap+"`"+")'>" 
                            + '<p>'+jsob.sites[i].name+''+"</p>"+
                            "<button class='btn btn-primary' onclick='redirect("+jsob.sites[i].lat+","+jsob.sites[i].lot+","+"`"+jsob.sites[i].name+"`"+","+"`"+jsob.sites[i].src+"`"+","+"`"+jsob.sites[i].cap+"`"+")'>Select Evacuation Site</button>"+
                            "</div>");

                            var m  =  L.marker([jsob.sites[i].lat, jsob.sites[i].lot], {icon: schoolIcon}).on('click', function(e) { fill_card(jsob.sites[i].lat,jsob.sites[i].lot,jsob.sites[i].name,jsob.sites[i].src,jsob.sites[i].cap)}).addTo(map).bindPopup(popup);

                            schools.push(m);
                            all.push(m);

                          }else if (jsob.sites[i].type === "hall"){

                            var popup = L.popup().setContent("<div id='"+jsob.sites[i].name+"' onclick='fill_card("+jsob.sites[i].lat+","+jsob.sites[i].lot+","+"`"+jsob.sites[i].name+"`"+","+"`"+jsob.sites[i].src+"`"+","+"`"+jsob.sites[i].cap+"`"+")'>" 
                            + '<p>'+jsob.sites[i].name+''+"</p>"+
                            "<button class='btn btn-primary' onclick='redirect("+jsob.sites[i].lat+","+jsob.sites[i].lot+","+"`"+jsob.sites[i].name+"`"+","+"`"+jsob.sites[i].src+"`"+","+"`"+jsob.sites[i].cap+"`"+")'>Select Evacuation Site</button>"+
                            "</div>");

                            var m  =  L.marker([jsob.sites[i].lat, jsob.sites[i].lot], {icon: hallIcon}).on('click', function(e) { fill_card(jsob.sites[i].lat,jsob.sites[i].lot,jsob.sites[i].name,jsob.sites[i].src,jsob.sites[i].cap)}).addTo(map).bindPopup(popup);

                            halls.push(m);
                            all.push(m);
                          }                          
                        }

                       

                        var smarkers = L.layerGroup(schools);
                        var hmarkers = L.layerGroup(halls);
                        var amarkers = L.layerGroup(all);

                        var overlayMaps = {
                          "All": amarkers,
                          "Schools": smarkers,
                          "Gym Halls": hmarkers
                        };

                        L.control.layers(overlayMaps).addTo(map);

                        const flood =[ ["Flood Events", "Water Level"] ];

                        for (let i in jsob.typhoons) {
                          if (jsob.typhoons[i].Cause === "Heavy Rainfall") {


                          var para = document.createElement("div");               // Create a <p> element
                          para.innerHTML = "<br><div class='wcard row'>"+
                              "<div class='wcard__info col-2'  style='flex-grow: 3'>"+
                                "<p class='wcard__info__place text-muted' id='weather'>"+jsob.typhoons[i].Cause+"</p>"+
                                "<p class='wcard__info__time'  style='font-size:30px'>"+jsob.typhoons[i].Cause+"</p>"+
                                "<p class='wcard__info__date text-muted'>"+jsob.typhoons[i].Timeframe+"</p>"+
                              "</div>"+
                              "<div class='wcard__weather col-2'  style='flex-grow: 1'>"+
                               "<img src='src/imgs/heavy.jpg' class='card-img wcard__weather__icon' id='weathericon' alt='' style='width:90px; height: 90px; margin:auto;'>"+
                                "<div style='margin: 0;'>"+
                                  "<p class='wcard__info__date text-muted'>Water Level :"+jsob.typhoons[i].level+"M</p>"+
                                 "<p class='card-text'  style='font-size:10px'>Areas Affected</p>"+
                                 "<p class='card-text text-muted'  style='font-size:10px'> "+jsob.typhoons[i].Areas+"</p>"+
                                "</div>"+
                              "</div>"+
                            "</div>";                                           // Append the text to <p>

                             document.getElementById("typhoon").appendChild(para);
                             flood.push([jsob.typhoons[i].Cause,jsob.typhoons[i].level]); 


                          }else if (jsob.typhoons[i].Cause === "Typhoon") {

                            var para = document.createElement("div");               // Create a <p> element
                            para.innerHTML =
                            "<br><div class='wcard row'>"+
                              "<div class='wcard__info col-2'  style='flex-grow: 5'>"+
                                "<p class='wcard__info__place text-muted' id='weather'>"+jsob.typhoons[i].Cause+"</p>"+
                                "<p class='wcard__info__time'  style='font-size:30px'>"+jsob.typhoons[i].name+"</p>"+
                                "<p class='wcard__info__date text-muted'>"+jsob.typhoons[i].Timeframe+"</p>"+
                                "<p class='wcard__info__date text-muted'><i class='fas fa-wind'></i>"+jsob.typhoons[i].winds+"</p>"+
                                "<p class='wcard__info__date text-muted'><i class='fas fa-tachometer-alt'></i>"+jsob.typhoons[i].pressure+"</p>"+
                                "<p class='wcard__info__date text-muted'>"+jsob.typhoons[i].Formed+","+jsob.typhoons[i].Dissipated+"</p>"+
                              "</div>"+
                              "<div class='wcard__weather col-2'  style='flex-grow: 3'>"+
                               "<img src='src/imgs/typhoon.png' class='card-img wcard__weather__icon' id='weathericon' alt='' style='width:90px; height: 90px; margin:auto;'>"+
                                "<div style='margin: 0;'>"+
                                 "<p class='wcard__info__date text-muted'>Water Level: "+jsob.typhoons[i].level+"M</p>"+
                                 "<p class='card-text'  style='font-size:10px'>Areas Affected</p>"+
                                 "<p class='card-text text-muted'  style='font-size:10px'> "+jsob.typhoons[i].Areas+"</p>"+
                                "</div>"+
                              "</div>"+
                            "</div>";

                              document.getElementById("typhoon").appendChild(para);
                              flood.push([jsob.typhoons[i].name,jsob.typhoons[i].level]);  
                          }

                        }

                            var twit = document.createElement("div");                 
                            twit.innerHTML =jsob.twit[1].data;

                            document.getElementById("socials").appendChild(twit);

                            twttr.widgets.load(
                              document.getElementById("socials")
                            );

                            var fb = document.createElement("div");               
                            fb.innerHTML =jsob.fb[1].data;

                            document.getElementById("fb").appendChild(fb);
                             
                     
                              google.charts.load('current', {'packages':['bar']});
                              google.charts.setOnLoadCallback(drawStuff);

                              function drawStuff() {
                                var data = new google.visualization.arrayToDataTable(flood);

                                var options = {
                                  width: 300,
                                  legend: { position: 'none' },
                                  chart: {
                                    title: 'Cause and River level',
                                    subtitle: 'Previous Flood Events in Marikina ' },
                                  bar: { groupWidth: "60%" }
                                };

                                var chart = new google.charts.Bar(document.getElementById('columnchart_values'));
                                // Convert the Classic options to Material options.
                                chart.draw(data, google.charts.Bar.convertOptions(options));
                              };

                      },
                      error: function(error) {
                        alert("error: "+error);
                      }
                  })


function redirect(lat,lot,evac,src,cap){
  sessionStorage.setItem("Lat", lat);
  sessionStorage.setItem("Lot", lot);
  sessionStorage.setItem("src", src);
  sessionStorage.setItem("Evac", evac);
  sessionStorage.setItem("Cap", cap);
  window.location.href = 'try.html';
}

function fill_card(lat,lot,evac,src,cap){

    document.getElementById("loctab").innerHTML = "" ;
    document.getElementById("at").textContent = "";
    document.getElementById("on").textContent = "";
    document.getElementById("cap").textContent = "";
    document.getElementById("pimg").src = "";

    document.getElementById("evt").innerHTML = "EVACUATION SITE" ;
    document.getElementById("loctab").innerHTML = evac ;
    document.getElementById("at").textContent = lat;
    document.getElementById("on").textContent = lot;
    document.getElementById("cap").textContent = cap;
    document.getElementById("pimg").src = src;
}


</script>
<script type="text/javascript" defer>
var lt = sessionStorage.getItem('ulat');
var ln = sessionStorage.getItem('ulot'); 

       $.ajax({
            url: "http://api.weatherapi.com/v1/current.json?key=b183a0ff45b54688a7380107220501&q="+lt+ ',' +ln+"&aqi=yes",
            type: "GET",
            success: function (result) {
              var tojson = JSON.stringify(result);
              var weather = JSON.parse(tojson);
              document.getElementById("weathericon").src = "https:"+weather.current.condition.icon;
              n =  new Date();
              y = n.getFullYear();
              m = n.getMonth() + 1;
              d = n.getDate();
              document.getElementById("date").innerHTML = m + "/" + d + "/" + y;
              document.getElementById("weather").textContent = weather.current.condition.text;
              document.getElementById("wind").textContent = weather.current.wind_kph+"km/h";
              document.getElementById("c").textContent = weather.current.feelslike_c+"°C";
              //document.getElementById("f").textContent = weather.current.feelslike_f+"°F";
              console.log(weather);
              swal({
                title:"Welcome!",
                text: "Weather in Marikina is "+weather.current.condition.text,
                icon:"https:"+weather.current.condition.icon,
                button:"Proceed"
              });
            },
            error: function(error) {
              alert("error: "+error);
              }
            })      

</script>
</html>
